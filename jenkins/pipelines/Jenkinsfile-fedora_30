pipeline {
  agent {
    docker {
      //image 'fedora:30'
      image 'controller.trafficserver.org/ats/old_ci/fedora:30'
      registryUrl 'https://controller.trafficserver.org/'
      label 'docker3'
    }
  }

  stages {
    stage('Clone') {
      steps {
        dir('src') {
          git 'http://jenkins.trafficserver.org/mirror/trafficserver.git'
        }
        dir('ci') {
          git branch: 'fedora', url: 'https://github.com/traeak/trafficserver-ci.git'
        } 
        echo 'Finished Cloning'
      }
    }
    stage('Build') {
      steps {
        echo 'Starting build'
        dir('src') {
          //sh 'source ci/jenkins/bin/environment.sh'
          sh 'source ci/jenkins/bin/in_tree.sh'
        }

/*
        dir('src') {
            sh 'autoreconf -if'
            sh 'mkdir BUILDS'
        }
        dir('src/BUILDS') {
          sh '../configure --enable-werror --enable-experimental-plugins --enable-example-plugins --enable-wccp'
          sh 'make -j4'
        }
*/
      }
    }
  }
//  post { 
//    always { 
//      cleanWs()
//    }
//  }
}
